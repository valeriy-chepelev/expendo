# Expendo2
v.2.2

Утилита предназначена для сбора и анализа информации о выполнении проектов в системе Yandex Tracker.

Expendo выполняется из консоли в текстовом режиме и не имеет графического интерфейса.

Для сбора данных из Yandex Tracker используется прямое подключение к БД трекера по API.

## Изменения версии 2.2
- Добавлена возможность ручного ввода запроса к Yandex Tracker,
если Expendo2 запущен без указания запроса в командной строке.
- Добавлен вывод даты старта проекта (по первой оценке тикета) в сводной таблице статистики.
- Добавлен расчет и вывод параметров `created`, `succeed`,`wip` (количество тикетов: созданных, завершенных, в работе).

## Инструкции по сборке

Сборка в исполняемую утилиту под Windows при помощи pyinstaller командой:

        pyinstaller expendo2.spec

Зависимости (дополнительные пакеты, используемые при работе):
- alive-progress
- colorama
- matplolib
- natsort
- prettytable
- pyperclip
- yandex_tracker_client

# Руководство пользователя

## Быстрый старт

1.  **Получите** у администратора Yandex Tracker значения токена `XXX` и организации `YYY` 
2.  **Скопируйте название проекта** из Yandex Tracker
3.   **Запустите утилиту** из командной строки с запросом к Yandex Tracker:

        expendo2 "Project: \"My Project\"" --token XXX --org YYY

4.  Дождитесь завершения загрузки данных.
5.  **Задайте базовые параметры** (опционально):
    *   `mode daily` или `mode sprint` (анализировать данные по дням или спринтам)
    *   `base dd.mm.yy` (задать базовую дату спринтов)
    *   `period month to now` (анализировать данные за последний месяц)
6.  **Выполните анализ** для просмотра суммарного графика трудозатрат: `plot spent`
7.  **Выберите категорию**, подсвеченную зеленым цветом: `plot spent for category`
8.  **Постройте тренды** на основе данных: `plot trends spent`
9.  **Скопируйте данные** в CSV: `copy spent` и вставьте их в Excel.

Для сброса настроек категорий используйте команду `clear`.
Для повторного вывода общей статистики и списка категорий используйте `info` или пустую команду.
Для вывода справки по командам используйте `help`.

## Что можно делать в Expendo2
- Отбирать задачи для анализа, используя язык запросов Yandex Tracker.
- Выбирать группы задач по категориям, к которым относятся:
  - очереди
  - тэги
  - компоненты
  - проекты
  - корневые эпики.
- Исключать из выбранных групп задачи, относящиеся к иной группы (например, выполнить анализ для задач очереди Q1, но не имеющих тэга T1).
- Определять временной диапазон выполняемого анализа.
- Выполнять анализ на подневных или спринтовых данных, задавая при этом длительность спринта и базовую дату начала спринтов.
- Для выбранных групп задач получать расчет:
  - затраченного времени (**Spent**) нарастающим итогом
  - оценки трудозатрат (**Estimate**) - диаграмма сгорания
  - начальной оценки трудозатрат (**Original**) - аналог диаграммы сгорания без учета переоценок
  - сгоревшей начальной оценки (**Burn**) - суммарной начальной оценки закрытых задач
  - количества созданных (**Created**) и закрытых (**Succeed**) тикетов и тикетов, находящихся в работе (**WIP**).
  - скорости изменения (дифференциала) указанных показателей.
- Получать результат в виде табличных данных на консоли.
- Экспортировать рассчитанные данные в формате CSV через системный буфер обмена.
- Отображать полученные данные в виде неограниченного количества одно- и многорядных временных диаграмм в отдельных графических виджетах.
- Полученные диаграммы можно масштабировать, считывать с них значения, сохранять в виде файлов.
- По полученным данным можно выполнить автоматическое построение кусочно-линейных трендов.
- На трендах на разных временных промежутках можно получить:
  - скорость изменения показателя, часов в единицу времени
  - относительную скорость команды
  - дату ожидаемого финиша (для **Estimate** и **Original**)
  - ускорение изменения показателя (вторая производная, при расчете скорости изменения показателей)
- Отобразить тренды в табличной форме, на графических диаграммах, экспортированы в формате CSV.

Для управления анализом Expendo2 предоставляет командную строку, через которую можно подавать команды, оперативно меняя настройки и вызывая искомые результаты.

## Запуск Expendo2

Запуск выполняется из командной строки (или через настроенный ярлык).

**При первом запуске необходимо задать ключ подключения к Yandex Tracker** - `token` и `org-id` , используя дополнительные параметры:

    expendo2 Project:MyProject --token your-token-value --org your-org-id

> Expendo2 сохраняет параметры в файле `expendo2.ini` и будет использовать их при последующих запусках.
***
При вызове в качестве основного параметра можно добавить запрос
на [языке запросов Yandex Tracker](https://yandex.ru/support/tracker/ru/user/query-filter):

    expendo2 Project:MyProject

Обычно запрос может содержать пробелы, тогда параметр необходимо заключить в двойные кавычки:

    expendo2 "Queue: MQQ AND Tag: ideas"

Запрос может и сам содержать в себе двойные кавычки, тогда их необходимо "экранировать" символом обратной черты:

    expendo2 "Project: \"My lovely project\""


> Если вызов Expendo2 выполняется без указания запроса, утилита покажет предыдущий
> запрос и предложит ввести новый запрос -
> или просто нажать `Enter` для использования предыдущего запроса.
> 
> В таком режиме при вводе запроса не требуется использовать дополнительные кавычки и "экранирование".
> Также такой режим делает удобным запуск утилиты при помощи ярлыка.


При запуске Expendo2 соединяется с Yandex Tracker и выполняет предварительную обработку данных согласно запросу.

Время предварительной обработки зависит от количества отобранных тикетов, качества связи и скорости работы сервера,
и обычно составляет 2-10 тикетов в секунду.

Вся дальнейшая обработка данных в Expendo2 выполняется с минимальными задержками.

> При предварительной обработке Expendo2 запоминает существенную часть полученной от сервера информации, что позволяет ускорить её обработку, но при этом:
> 
> Изменения, произошедшие в БД сервера после запуска Expendo2, не будут учтены в анализе.
> 
> Дл некоторых операций Expendo2 может обращаться к серверу, так что связь должна поддерживаться.

После предварительной обработки Expendo2 рассчитывает и выводит на экран общую статическую и справочную информацию,
и предоставляет командную строку для ввода команд.

## Общие команды

> Общие команды не имеют параметров, не могут быть вместе с другими командами, исполняются сразу.

### help, h, ?
Выводит краткую справку по командам.
### info или пустая команда
Выводит общую статистическую и справочную информацию (как при запуске).
### clear
Очищает выбранные категории и исключения (см. ниже).
### quit, exit, q
Завершает работу Expendo2. При завершении работы все графические виджеты автоматически закрываются.

***

## Параметры

> Задаваемые значения параметров сохраняются в программе и в файле `expendo2.ini`.
>
> Все параметры могут быть заданы через соответствующие аргументы при запуске Expendo2.
>
> Одной командой можно изменить несколько параметров сразу.
>

### mode
Задает режим шага по времени: `daily` день или `sprint` спринт.

Пример: `mode daily`

Параметр командной строки `--mode`

### length

Задает длительность спринта в днях для режима `sprint`.

Пример: `length 14`

Параметр командной строки `--length`

### base

Задает базовую дату спринтов для режима `sprint` в формате dd.mm.yy.
Относительно этой даты будут рассчитываться даты начала/окончания всех спринтов.
> Отбор данных по дате выполняется по условию `tiket_date <= date`, т.е.:
> 
> Если спринт 1 начался 20.08.25, а спринт 2 начался 03.09.25, то трудозатраты и оценки тикетов,
> выполненные 03.09.25, будут отнесены также к спринту 2. 

Пример: `base 17.09.25`

Параметр командной строки `--base`

### period ... to
Задает временной диапазон анализа. Состоит из двух частей:

- первая часть `period` задает длительность или начальную дату диапазона:
  - `today`, `now` - сегодня
  - `yesterday` - вчера
  - `week` - неделя
  - `sprint` - спринт
  - `month` - месяц
  - `quarter` - квартал
  - `year` - год
  - `all`, `full` - весь диапазон отобранных по запросу тикетов
  - дата в формате dd.mm.yy - фиксированная дата
- вторая часть to задает конечную дату диапазона:
  - `today`, `now` - сегодня
  - `yesterday` - вчера
  - дата в формате dd.mm.yy - фиксированная дата

Команда может содержать только первую часть, задающую длительность диапазона.

> Длительности диапазона анализа определяют только количество дней в диапазоне
> и не привязаны к сущности терминов. Т.е. длительность в квартал понимается только
> как три месяца до конечной даты, а не календарный квартал.

Примеры: `period all to now`, `period quarter`, `period month to 03.09.24`

Параметры командной строки `--period`, `--to`,
использование значений в формате дат в параметрах командной строки не допускается.

### regression

Задает метод вычисления штрафных коэффициентов при расчете
кусочно-линейных трендов: `residuals`, `differences`, `smooth`.

Подробное описание математических методов и рекомендации по их применению см. в разделе "Матаппарат".

Пример: `regression smooth`

Параметр командной строки `--trend`

### factor

Задает масштабный штрафной коэффициент в виде целого числа, используемый при расчете
кусочно-линейных трендов.

Типовые значения 3 - 30. Меньшее значение приводит к большему количеству сегментов трендов.

Принцип расчета и рекомендации по выбору значения подробно описаны в разделе "Матаппарат".

Пример: `factor 20`

Параметр командной строки `--factor`

### velocity

Задает величину номинальной скорости команды Vном в виде числа, часов в сутки.
Значение используется при расчете скорости команды на трендах.

При задании значения следует учитывать, что на долгосрочных трендах Expendo2 не учитывает выходные и праздничные дни.
Поэтому в качестве начального значения задано усредненное значение
для команды из одного человека при 8-часовом рабочем дне и пятидневной рабочей недели:

    Vном = 8 * 5 / 7 = 5.71

При анализе долгосрочных трендов (в масштабе года) можно использовать более точное значение,
учитывающее количество рабочих дней в году (пример для 2025 года, 1972 - количество рабочих часов в году):

    Vном = 1972 / 365  = 5.4

Пример: `velocity 5.71`

Параметр командной строки `--velocity`

***

## Команды анализа данных

> Команды анализа включают в себя несколько разных подгрупп.
> 
> Вся подаваемая команда может включать в себя несколько различных выражений в любом порядке.
> 
> Все выражения в составе команды (кроме `dv` и `trends`) запоминаются и применяются при следующих командах.
> 
> Результатом подачи команды анализа данных является вывод затребованной информации.

### Как выводить

`dump` - вывод таблицы в консоль
(при выполнении команды trends выводится только таблица трендов)

`plot` - вывод графиков в новом графическом виджете

`copy` - копирование результатов вычисление в системный буфер обмена в формате CSV
(при выполнении команды trends копируются только данные трендов)

### Что вычислять

`spent` - затраченное время

`estimate` - оценка трудозатрат

`original` - начальная оценка трудозатрат

`burn` - сгоревшая начальная оценка трудозатрат

`created` - количество созданных тикетов

`succeed` - количество разрешенных (успешно закрытых) тикетов

`wip` - количество тикетов "в работе"

`dv` - **модификатор**, показывающий, что надо вычислить дифференциал (скорость) заданного параметра; **не запоминается**

`trends` - **модификатор**, показывающий, что надо вычислить тренды заданного параметра; **не запоминается**

### Для каких категорий вычислять

`for` - перечень категорий, для каждой из которых следует провести анализ

`exclude` - перечень категорий, которые следует исключить из анализа

Если категории не выбраны, вычисления проводятся суммарно для всех тикетов.

Перечень доступных категорий выводится в общей информации (команда `info`),
идентификаторы категорий выделены зеленым цветом.

Выбранные категории выделены голубым цветом, исключенные - красным цветом.

Для сброса выбранных и исключенных категорий следует подать команду `clear`.

### В каком временном диапазоне вычислять

Команды задают временной диапазон анализа, аналогично команде `period` ... `to`.
Измененные значения также сохраняются в файле `expendo2.ini`.

`at`, `from` - длительность `today`, `now`, `yesterday`, `week`, `sprint`, `month`, `quarter`, `year`, `all`, `full`
или начальная дата в формате dd.mm.yy

`to` - конечная дата `today`, `now`, `yesterday` или дата в формате dd.mm.yy

### Пример анализа

    plot estimate for MQA MQB exclude debt at all to now
    ' выводит графики estimate во всём временном диапазоне для двух категорий MQA, MQB, исключая debt
    at month
    ' повторно выводит график, но за месяц
    copy
    ' копирует данные за месяц в буфер в формате CSV
    plot trends
    ' повторно выводит график за месяц, дополнив его трендами
    from now for MQA dump
    ' табличку выводит с estimate текущим для категории MQA, debt исключая
    plot trends at all
    ' выводит график с estimate и трендами для категории MQA, исключая debt

# Предупреждение: Типичные ошибки при анализе

## Ограничение временного диапазона в запросе к Yandex Tracker

В запросах Yandex Tracker можно использовать фильтры по времени вида `Created:`, `Updated:`.

Следует учитывать, что в проектах могут присутствовать тикеты, созданные или обновленные очень давно - тогда они
не попадут в анализ, что может исказить результаты.

## Особенности временных диапазонов в запросах Yandex Tracker

В запросах Yandex Tracker для фильтров по времени возможны конструкции `year()`, `quarter()`, `month()`.

Эти конструкции, в отличие от аналогичных команд Expendo2, означают текущий календарный период, а не длительность.

Если 03.09 отобрать задачи запросом `Created: >= month()`, то получим только тикеты, созданные за первые три дня сентября. 

## Забытый exclude

`for` и `exclude` - это две разные независимые команды.

Если сначала подаем команду `for c1 c2 c3 exclude c4` - получаем данные трех категорий за вычетом четвертой,
а потом подаем команду `for c5`, то получим не пятую категорию полностью, а пятую за вычетом четвертой,
т.к. `exclude c4` продолжает действовать.

Для очистки запомненных значений категорий команд `for` и `exclude` следует подать команду `clear`. 

## Широкий отбор исходных данных

Expendo2 определяет категории тикетов только по их текущему состоянию, и не учитывает их изменения за период жизни.

Так, если некий тикет был когда-то перенесен из Проекта1 в Проект2, то все затраты по нему при анализе будут
отнесены только на Проект2.

И аналогично, если в этом тикете был выставлен некий тег, то при анализе Проекта1 и отбору только по тегу,
все данные перенесенного тикета будут ошибочно учтены.

## Совпадение категорий

Expendo2 распознает категории по их наименованию. В случае если разные сущности категорий имеют одинаковое наименование,
некоторые из них могут оказаться недоступны.

Expendo2 распознает категории в последовательности: теги - компоненты - очереди (по идентификатору) -
проекты (по наименованию) - эпики (по номеру тикета). Если наименование, к примеру, тега и очереди, будет совпадать,
то отбор тикетов всегда будет выполняться по тегу.

Следует избегать таких совпадений наименований в системе Yandex Tracker.

Также надо учесть, что эпики идентифицируются только по номеру (например, 115 для MTPD-115).

***

# Матаппарат

## Учет затрат и оценок

В расчетах учитывается вся информация об истории изменений значений `Spent` и `Estimation`
тикетов типа `Задача` (`Task`) и `Ошибка` (`Bug`).

Данные остальных типов тикетов игнорируются.

## Определение начальной и сгоревшей оценок трудозатрат

`original` - это начальная оценка открытых тикетов.

В качестве начальной оценки принимается значение поля `estimate`
на момент первой постановки тикета в работу,
или же последнее установленное значение если тикет в работу не ставился.

Значение начальной оценки `original` применяется на всем временном диапазоне от создания тикета до его закрытия.

`burn` - даты сгорания начальных оценок определяются по факту закрытия тикетов.

Датой сгорания принимается момент последней установки поля `resolution=fixed`.
Незакрытые тикеты, или тикеты, для которых невозможно определить дату, исключаются из анализа.

## Тикет "в работе"

Тикет считается "в работе" с даты первого изменения его статуса на "В работе" до его закрытия.
Если тикет был возвращен в бэклог - все это время он считается "в работе".

## Корневые эпики

Корневые эпики задач определяются по типу связи `Родительская задача`,
при этом обрабатывается иерархия (ветви) неограниченной длины.

То есть "Корневой эпик" - это родительский тикет самого высшего уровня (в корне проекта), имеющий тип `Эпик` (`Epic`).

Если тикет (задача или баг) сам находится "в корне",
или же его высший родитель не является эпиком, "Корневой эпик" = `NoEpic`

## Выравнивание дат

Даты начала и окончания временного диапазона, задаваемые пользователем, выравниваются по условиям:

- для режима `daily`дата начала проверяется и корректируется обязательно меньше заданной даты завершения;
- для режима `sprint`
  - дата завершения корректируется на границу спринтов, но не позже заданной даты;
  - дата начала также корректируется на границу спринтов "вниз", но обязательно меньше скорректированной даты завершения.

В результате, к примеру, при подаче команды `from today to today` в режиме `daily` будут выведены данные
за два дня: вчера и сегодня;

при подаче такой же команды в режиме `sprint`, причем в середине спринта N, будут выведены данные на даты
старта спринта N-1 и старта спринта N.

## Построение трендов

Для построения трендов используется метод кусочно-линейной аппроксимации
на основе bottom-up алгоритма.

Алгоритм выполняет итеративное объединение сегментов исходных данных,
начиная с начальных сегментов минимальной длины.
На каждой итерации выбирается пара соседних сегментов, объединение которых дает
минимальное увеличение ошибки аппроксимации (SSR).

Процесс продолжается до тех пор, пока стоимость объединения `ΔSSR - λ` остается положительной,
что обеспечивает баланс между точностью аппроксимации и количеством сегментов.

Ключевым метапараметром алгоритма является параметр регуляризации λ,
который определяет штраф за создание дополнительного сегмента.
Значение λ вычисляется автоматически на основе оценки дисперсии шума в исходных данных по формуле

    λ = C × σ²

, где σ² - дисперсия шума, а C - задаваемый коэффициент чувствительности.

Для начальной оценки дисперсии шума σ² доступны три метода:

- `residuals`: оценивает шум через отклонения от глобального линейного тренда.
Рекомендуется для данных с выраженной линейной тенденцией.
- `differences`: вычисляет дисперсию на основе первой производной ряда данных.
Наиболее эффективен для стационарных данных без выраженного тренда.
- `smooth`: использует отклонения от сглаженного ряда (методом скользящего среднего).
Универсальный метод, подходящий для данных со сложными нелинейными паттернами.

Параметр C позволяет регулировать степень сглаживания трендов: 
значения в диапазоне 3-10 обеспечивают баланс между детализацией и устойчивостью к шуму.

Увеличение C приводит к получению более сглаженных трендов с меньшим количеством сегментов,
и наоборот, уменьшение C позволяет выделять более детальные изменения в данных.

Для начальной настройки рекомендуется использовать метод `smooth` со значением `C = 5`,
а затем корректировать параметры в зависимости
от характеристик конкретных данных и требуемой степени детализации трендов.

Expendo2 показывает только участки трендов, характерные для типа обрабатываемого параметра:
растущие для `spent`, `burn`, `created`, `succeed`, убывающие для `estimate` и `original`.

## Вычисление скорости

При вычислении линий трендов каждый из участков тренда описывается линейным уравнением:

    y = ax + b

, где x - шкала времени (дни или спринты); y - значение параметра (часы трудозатрат);

  a - коэффициент наклона линии, фактическая скорость изменения параметра, часов в единицу времени;

  b - величина параметра в начальный момент времени.

Скорость команды, выраженная в часах в единицу времени, пересчитывается в относительную скорость, выраженную
в номиналах Vном.

На долгосрочных трендах Expendo2 не учитывает выходные и праздничные дни, поэтому в качестве начального значения
Vном принято усредненное значение скорости одного человека при 8-часовом рабочем дне
и пятидневной рабочей недели:

    Vном = 8 * 5 / 7 = 5.71

При анализе долгосрочных трендов (в масштабе года) можно использовать более точное значение,
учитывающее количество рабочих дней в году (пример для 2025 года, 1972 - количество рабочих часов в году):

    Vном = 1972 / 365  = 5.4

## Вычисление финальных дат

Финальные даты трендов вычисляются по линейному уравнению:

    ax+b=0, x=-b/a

, дающему x - количество единиц времени (дней или спринтов) от начала системы координат до нулевого значения.

Даты вычисляются только для нисходящих трендов (`a<0`, будущее), что соответствует 
типовому процессу для диаграмм сгорания `estimate` и `original`. 

***

# Futures

- статистические показатели time-to-resolve, time-to-start,
spent-estimate-ratio, гистограммы
- листинг тикетов
- группировка категорий методами union, intersection, в т.ч. итеративно
- информативные заголовки окон графических виджетов

        Disclaimer: "Yandex" и "Yandex Tracker" являются объектами авторского права их владельца.