# Expendo2
v.2.0

Утилита предназначена для сбора и анализа информации о выполнении проектов в системе Yandex Tracker.

Expendo выполняется из консоли в текстовом режиме и не имеет графического интерфейса.

Для сбора данных из Yandex Tracker используется прямое подключение к БД трекера по API.

## Что можно делать в Expendo2
- Отбирать задачи для анализа, используя язык запросов Yandex Tracker.
- Выбирать группы задач по категориям, к которым относятся:
  - очереди
  - тэги
  - компоненты
  - проекты
  - корневые эпики.
- Исключать из выбранных групп задачи, относящиеся к иной группы (например, выполнить анализ для задач очереди Q1, но не имеющих тэга T1).
- Определять временной диапазон выполняемого анализа.
- Выполнять анализ на подневных или спринтовых данных, задавая при этом длительность спринта и базовую дату начала спринтов.
- Для выбранных групп задач получать расчет:
  - затраченного времени (**Spent**) нарастающим итогом
  - оценки трудозатрат (**Estimate**) - диаграмма сгорания
  - начальной оценки трудозатрат (**Original**) - аналог диаграммы сгорания без учета переоценок
  - сгоревшей начальной оценки (**Burn**) - суммарной начальной оценки закрытых задач
  - скорости изменения (дифференциала) указанных показателей.
- Получать результат в виде табличных данных на консоли.
- Экспортировать рассчитанные данные в формате CSV через системный буфер обмена.
- Отображать полученные данные в виде неограниченного количества одно- и многорядных временных диаграмм в отдельных графических виджетах.
- Полученные диаграммы можно масштабировать, считывать с них значения, сохранять в виде файлов.
- По полученным данным можно выполнить автоматическое построение кусочно-линейных трендов.
- На трендах на разных временных промежутках можно получить:
  - скорость изменения показателя, часов в единицу времени
  - относительную скорость команды
  - дату ожидаемого финиша (для **Estimate** и **Original**)
  - ускорение изменения показателя (вторая производная, при расчете скорости изменения показателей)
- Отобразить тренды в табличной форме, на графических диаграммах, экспортированы в формате CSV.

Для управление анализом Expendo2 предоставляет командную строку, через которую можно подавать команды, оперативно меняя настроки и вызывая искомые результаты.

## Запуск Expendo2

Запуск выполняется из командной строки (или через настроенный ярлык).

**При первом запуске необходимо задать ключ подключения к Yandex Tracker** - `token` и `org-id` , используя дополнительные параметры:

    expendo2 Project:MyProject --token your-token-value --org your-org-id

> Expendo2 сохраняет параметры в файле `expendo2.ini` и будет использовать их при последующих запусках.
***
При вызове в качестве основного параметра необходимо добавить запрос на языке Yandex Tracker:

    expendo2 Project:MyProject

Обычно запрос на языке Yandex Tracker может содержать пробелы, тогда параметр необходимо заключить в двойные кавычки:

    expendo2 "Queue: MQQ AND Tag: ideas"

Запрос может и сам содержать в себе двойные кавычки, тогда их необходимо "экранировать" символом обратной черты:

    expendo2 "Project: \"My lovely project\""

> Expendo2 сохраняет запрос в файле `expendo2.ini` и может использовать его при следующем запуске,
> если запрос в параметрах не указан.

При запуске Expendo2 соединяется с Yandex Tracker и выполняет предварительную обработку данных согласно запросу.

Время предварительной обработки зависит от количества отобранных тикетов, качества связи и скорости работы сервера,
и обычно составляет 2-10 тикетов в секунду.

Вся дальнейшая обработка данных в Expendo2 выполняется с минимальными задержками.

> При предварительной обработке Expendo2 запоминает существенную часть полученной от сервера информации, что позволяет ускорить её обработку, но при этом:
> 
> Изменения, произошедшие в БД сервера после запуска Expendo2, не будут учтены в анализе.
> 
> Дл некоторых операций Expendo2 может обращаться к серверу, так что связь должна поддерживаться.

После предварительной обработки Expendo2 рассчитывает и выводит на экран общую статическую и справочную информацию,
и предоставляет командную строку для ввода команд.

## Общие команды

> Общие команды не имеют параметров, не могут быть вместе с другими командами, исполняются сразу.

### help, h, ?
Выводит краткую справку по командам.
### info или пустая команда
Выводит общую статистическую и справочную информацию (как при запуске).
### clear
Очищает выбранные категории и исключения (см. ниже).
### quit, exit, q
Завершает работу Expendo2. При завершении работы все графические виджеты автоматически закрываются.

***

## Параметры

> Задаваемые значения параметров сохраняются в программе и в файле `expendo2.ini`.
>
> Все параметры могут быть заданы через соответствующие аргументы при запуске Expendo2.
>
> Одной командой можно изменить несколько параметров сразу.
>

### mode
Задает режим шага по времени: `daily` день или `sprint` спринт.

Пример: `mode daily`

Параметр командной строки `--mode`

### length

Задает длительность спринта в днях для режима `sprint`.

Пример: `length 14`

Параметр командной строки `--length`

### base

Задает базовую дату спринтов для режима `sprint` в формате dd.mm.yy.
Относительно этой даты будут рассчитываться даты начала/окончания всех спринтов.
> Отбор данных по дате выполняется по условию `tiket_date <= date`, т.е.:
> 
> Если спринт 1 начался 20.08, а спринт 2 начался 03.09, то трудозатраты и оценки тикетов,
> выполненные 03.09, будут отнесены также к спринту 2. 

Пример: `base 17.09.25`

Параметр командной строки `--base`

### period ... to
Задает временной диапазон анализа. Состоит из двух частей:

- первая часть `period` задает длительность или начальную дату диапазона:
  - `today`, `now` - сегодня
  - `yesterday` - вчера
  - `week` - неделя
  - `sprint` - спринт
  - `month` - месяц
  - `quarter` - квартал
  - `year` - год
  - `all`, `full` - весь диапазон отобранных по запросу тикетов
  - дата в формате dd.mm.yy - фиксированная дата
- вторая часть to задает конечную дату диапазона:
  - `today`, `now` - сегодня
  - `yesterday` - вчера
  - дата в формате dd.mm.yy - фиксированная дата

Команда может содержать только первую часть, задающую длительность диапазона.

> Длительности диапазона анализа определяют только количество дней в диапазоне
> и не привязаны к сущности терминов. Т.е. длительность в квартал понимается только
> как три месяца до конечной даты, а не календарный квартал.

Примеры: `period all to now`, `period quarter`, `period month to 03.09.24`

Параметры командной строки `--period`, `--to`, использование значений в формате дат не допускается.

### regression

Задает метод вычисления штрафных коэффициентов при расчете
кусочно-линейных трендов: `residuals`, `differences`, `smooth`.

Подробнее см. раздел "Матаппарат".

Пример: `regression smooth`

Параметр командной строки `--trend`

### factor

Задает масштабный штрафной коэффициент в виде целого числа, используемый при расчете
кусочно-линейных трендов.

Типовые значения 3 - 30. Меньшее значение приводит к большему количеству сегментов трендов.

Подробнее см. раздел "Матаппарат".

Пример: `factor 20`

Параметр командной строки `--factor`

### velocity

Задает величину номинальной скорости команды Vном в виде числа, часов в сутки.
Значение используется при расчете скорости команды на трендах.

При задании значения следует учитывать, что на долгосрочных трендах Expendo2 не учитывает выходные и праздничные дни.
Поэтому в качестве начального значения задано усредненное значение
для команды из одного человека при 8-часовом рабочем и пятидневной рабочей недели:

    Vном = 8 * 5 / 7 = 5.71

При анализе долгосрочных трендов (в масштабе года) можно использовать более точное значение,
учитывающее количество рабочих дней в году (пример для 2025 года, 1972 - количество рабочих часов в году):

    Vном = 1972 / 365  = 5.4

Пример: `velocity 5.71`

Параметр командной строки `--velocity`

***

## Команды анализа данных

> Команды анализа включают в себя несколько разных подгрупп.
> 
> Вся подаваемая команда может включать в себя несколько различных выражений в любом порядке.
> 
> Все выражения в составе команды (кроме `dv` и `trends`) запоминаются и применяются при следующих командах.
> 
> Результатом подачи команды анализа данных является вывод затребованной информации.

### Как выводить

`dump` - вывод таблицы в консоль
(при выполнении команды trends выводится только таблица трендов)

`plot` - вывод графиков в новом графическом виджете

`copy` - копирование результатов вычисление в системный буфер обмена в формате CSV
(при выполнении команды trends копируются только данные трендов)

### Что вычислять

`spent` - затраченное время

`estimate` - оценка трудозатрат

`original` - начальная оценка трудозатрат

`burn` - сгоревшая начальная оценка трудозатрат

`dv` - модификатор, показывающий, что надо вычислить дифференциал (скорость) заданного параметра; **не запоминается**

`trends` - модификатор, показывающий, что надо вычислить тренды заданного параметра; **не запоминается**

### Для каких категорий вычислять

`for` - перечень категорий, для каждой из которых следует провести анализ

`exclude` - перечень категорий, которые следует исключить из анализа

Если категории не выбраны, вычисления проводятся суммарно для всех тикетов.

Перечень доступных категорий выводится в общей информации (команда `info`),
идентификаторы категорий выделены зеленым цветом.

Выбранные категории выделены голубым цветом, исключенные - красным цветом.

Для сброса выбранных и исключенных категорий следует подать команду `clear`.

### В каком временном диапазоне вычислять

Команды задают временной диапазон анализа, аналогично команде `period` ... `to`.
Измененные значения также сохраняются в файле `expendo2.ini`.

`at`, `from` - длительность `today`, `now`, `yesterday`, `week`, `sprint`, `month`, `quarter`, `year`, `all`, `full`
или начальная дата в формате dd.mm.yy

`to` - конечная дата `today`, `now`, `yesterday` или дата в формате dd.mm.yy

### Пример анализа

    plot estimate for MQA MQB exclude debt at all to now
    ' выводит графики estimate во всём временном диапазоне для двух категорий MQA, MQB, исключая debt
    at month
    ' повторно выводит график, но за месяц
    copy
    ' копирует данные за месяц в буфер в формате CSV
    plot trends
    ' повторно выводит график за месяц, дополнив его трендами
    from now for MQA dump
    ' табличку выводит с estimate текущим для категории MQA, debt исключая
    plot trends at all
    ' выводит график с estimate и трендами для категории MQA, исключая debt

# Предупреждение: Типичные ошибки при анализе

## Ограничение временного диапазона в запросе к Yandex Tracker

В запросах Yandex Tracker можно использовать фильтры по времени вида `Created:`, `Updated:`.

Следует учитывать, что в проектах могут присутствовать тикеты, созданные или обновленные очень давно - тогда они
не попадут в анализ, что может исказить результаты.

## Особенности временных диапазонов в запросах Yandex Tracker

В запросах Yandex Tracker для фильтров по времени возможны конструкции `year()`, `quarter()`, `month()`.

Эти конструкции, в отличие от аналогичных команд Expendo2, означают текущий календарный период, а не длительность.

Если 03.09 отобрать задачи запросом `Created: >= month()`, то получим только тикеты, созданные за первые три дня сентября. 

## Забытый exclude

`for` и `exclude` - это две разные независимые команды.

Если сначала подаем команду `for c1 c2 c3 exclude c4` - получаем данные трех категорий за вычетом четвертой,
а потом подаем команду `for c5`, то получим не пятую категорию полностью, а пятую за вычетом четвертой,
т.к. `exclude c4` продолжает действовать.

Для очистки запомненных значений категорий команд `for` и `exclude` следует подать команду `clear`. 

## Широкий отбор исходных данных

Expendo2 определяет категории тикетов только по их текущему состоянию, и не учитывает их изменения за период жизни.

Так, если некий тикет был когда-то перенесен из Проекта1 в Проект2, то все затраты по нему при анализе будут
отнесены только на Проект2.

И аналогично, если в этом тикете был выставлен некий тег, то при анализе Проекта1 и отбору только по тегу,
все данные перенесенного тикета будут ошибочно учтены.

## Совпадение категорий

Expendo2 распознает категории по их наименованию. В случае если разные сущности категорий имеют одинаковое наименование,
некоторые из них могут оказаться недоступны.

Expendo2 распознает категории в последовательности: теги - компоненты - очереди (по идентификатору) -
проекты (по наименованию) - эпики (по номеру тикета). Если наименование, к примеру, тега и очереди, будет совпадать,
то отбор тикетов всегда будет выполняться по тегу.

Следует избегать таких совпадений наименований в системе Yandex Tracker.

***

# Матаппарат

TBD

***

# Futures

- группировка категорий методами union, intersection, в т.ч. итеративно
- информативные заголовки окон графических виджетов

# Contribution